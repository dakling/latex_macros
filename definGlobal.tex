% \usepackage{xparse}

% Default settings for all available options
\ProvideDocumentCommand{\EinsteinNotationDiff}{}{\BooleanTrue} % affects second derivatives
\ProvideDocumentCommand{\ShortHigherMoments}{}{\BooleanTrue} % abbreviate higher one-point velocity moments
\ProvideDocumentCommand{\ShowArgsTwoPoint}{}{\BooleanFalse} % show arguments eg in H_ij(x,y) 
\ProvideDocumentCommand{\diff}{m m g}{\diffPartial{#1}{#2}{#3}} % most frequently used type of derivative

%% general settings
%allow double superscripts
\catcode`\^ = 13 \def^#1{\sp{#1}{}}
% \catcode`\_ = 13 \def_#1{\sb{#1}{}}

%% low-level macros
% definition of a good looking bar
\NewDocumentCommand {\overbar} { m } {\mkern 1.5mu\overline{\mkern-1.5mu#1\mkern-1.5mu}\mkern 1.5mu}

%% semantic macros
% symbols to denote entire equations
\NewDocumentCommand {\nc} { m } { \mathcal{N}_{#1} }
\NewDocumentCommand {\ncm} { m } { \mathcal{\mean{N}}_{#1} }
\NewDocumentCommand {\ncf} { m } { \mathcal{N}_{#1}' }
% generic vector/tensor
\NewDocumentCommand{\vv} { m } { \mathbf{#1} }
\NewDocumentCommand{\xv} {  } { \mathbf{x} }
\NewDocumentCommand{\yv} {  } { \mathbf{y} }
\NewDocumentCommand{\te} { m } { \mathbf{#1} }
\NewDocumentCommand{\xt} {  } { \mathbf{x} }
\NewDocumentCommand{\yt} {  } { \mathbf{y} }
% "order of" symbol
\NewDocumentCommand {\order} { m g } { 
    \IfNoValueTF{#2}
    {\textit{O}(#1) }
    {\textit{O}(#1)^{#2} }
}
% evaluate (eg derivative) at position
\NewDocumentCommand {\atpos} { m m } { \bigg|_{{#1} = {#2}} }
% transformed (symmetries)
\NewDocumentCommand {\tra} {m} {#1^*}
% representation of similarity variables
\NewDocumentCommand {\simvar} {m} {\tilde{#1}}
% averaging
\NewDocumentCommand {\mean} { m } {\overbar{#1}}
% derivatives
\ExplSyntaxOn
\NewDocumentCommand {\diffGeneric} { m m m g } {
    \IfNoValueTF {#4}
        { \frac{#3 #1}{#3 #2} }
        { \int_compare:nTF { #4 = 2 } % second derivatives in Einstein notation
            { \IfBooleanTF {\EinsteinNotationDiff} % check if option is enabled
                {\frac{#3^#4 #1}{#3 #2 #3 #2} }
                {\frac{#3^#4 #1}{#3 #2^#4} }
            } 
            {{\frac{d #1}{d #2 ^#3}}} % higher derivatives, Einstein notation won't make sense in general
        }
}
\ExplSyntaxOff
\NewDocumentCommand {\diffNormal} { m m g } { \diffGeneric{#1}{#2}{d}{#3} }
\NewDocumentCommand {\diffPartial} { m m g } { \diffGeneric{#1}{#2}{\partial}{#3} }
\NewDocumentCommand {\diffTotal} { m m g } { \diffGeneric{#1}{#2}{D}{#3} }
\NewDocumentCommand {\um} {g g g g} {\umShort{#1}{#2}{#3}{#4} }
\NewDocumentCommand {\umShort} {g g g g} {
    \IfNoValueTF{#1}
        { \mean{U} }
        {\IfNoValueTF{#2}
            {\mean{U}_{#1}}
            { \IfNoValueTF{#3} 
                {H_{#1 #2}^0}
                { \IfNoValueTF{#4}
                    {H_{#1 #2 #3}^0}
                {H_{#1 #2 #3 #4}^0}
            }
        }
    }
}
\NewDocumentCommand {\umLong} {g g g g} {
    \IfNoValueTF{#1}
        { \umShort }
        {\IfNoValueTF{#2}
            {\umShort{#1}}
            { \IfNoValueTF{#3} 
                { \mean{ U_{#1} U_{#2} } }
                { \IfNoValueTF{#4}
                    {\mean{ U_{#1} U_{#2} U_{#3} }}
                {\mean{ U_{#1} U_{#2} U_{#3} U_{#4} }}
            } 
        }
    }
}
\NewDocumentCommand {\uf} {g g g g} {
    \IfBooleanTF{\ShortHigherMoments}
        {\ufShort{#1}{#2}{#3}{#4} }
        {\ufLong{#1}{#2}{#3}{#4} }
}
\NewDocumentCommand {\ufShort} {g g g g} {
    \IfNoValueTF{#1}
        { u }
        {\IfNoValueTF{#2}
            {u_{#1}}
            { \IfNoValueTF{#3} 
                {R_{#1 #2}^0}
                { \IfNoValueTF{#4}
                    {R_{#1 #2 #3}^0}
                {R_{#1 #2 #3 #4}^0}
            }
        }
    }
}
\NewDocumentCommand {\ufLong} {g g g g} {
    \IfNoValueTF{#1}
        { \ufShort }
        {\IfNoValueTF{#2}
            {\ufShort{#1}}
            { \IfNoValueTF{#3} 
                { \mean{ u_{#1} u_{#2} } }
                { \IfNoValueTF{#4}
                    {\mean{ u_{#1} u_{#2} u_{#3} }}
                {\mean{ u_{#1} u_{#2} u_{#3} u_{#4} }}
            } 
        }
    }
}
\RenewDocumentCommand {\pm} {} {\mean{P}}
\NewDocumentCommand {\pf} {} {p}
\ExplSyntaxOn
\NewDocumentCommand {\umTensor} { m } { 
    \int_compare:nTF { #1 = 1 } % 
    { \vv{\um} }
    { \vv{H^0} }
}
\NewDocumentCommand {\ufTensor} { m } { 
    \int_compare:nTF { #1 = 1 } % 
    { \vv{\uf} }
    { \vv{R^0} }
}
\NewDocumentCommand {\umTensorTwoPt} { m } { 
    \int_compare:nTF { #1 = 1 } % 
    { \vv{\um} }
    { \vv{H} }
}
\NewDocumentCommand {\ufTensorTwoPt} { m } { 
    \int_compare:nTF { #1 = 1 } % 
    { \vv{\uf} }
    { \vv{R} }
}
\ExplSyntaxOff
% two-point correlations
% instantaneous approach
\NewDocumentCommand {\umtWithoutArgsShort} {g g g g} {
    \IfNoValueTF{#1}
            { \um }
            {\IfNoValueTF{#2}
                {\um{#1} }
                { \IfNoValueTF{#3} 
                    {H_{#1 #2} }
                    { \IfNoValueTF{#4}
                        {H_{#1 #2 #3} }
                    {H_{#1 #2 #3 #4} }
                }
            }
        }
     }
\NewDocumentCommand {\umtWithArgsShort} {g g g g o o o o} {
        \IfNoValueTF{#1}
            { \um(\vv{#5}) }
            {\IfNoValueTF{#2}
                {\um{#1}(\vv{#5}) }
                { \IfNoValueTF{#3} 
                    {H_{#1 #2}(\vv{#5},\vv{#6}) }
                    { \IfNoValueTF{#4}
                        {H_{#1 #2 #3}(\vv{#5}, \vv{#6}, \vv{#7}) }
                        {H_{#1 #2 #3 #4}(\vv{#5}, \vv{#6}, \vv{#7}, \vv{#8}) }
                }
            }
        }
 }
\NewDocumentCommand {\umtShort} {g g g g o o o o} { 
    \IfNoValueTF{#5}
    { \umtWithoutArgsShort{#1}{#2}{#3}{#4} }
    { \IfBooleanTF{\ShowArgsTwoPoint}
        { \umtWithArgsShort{#1}{#2}{#3}{#4}[#5][#6][#7][#8] }
        { \umtWithoutArgsShort{#1}{#2}{#3}{#4} }
    }
}
\NewDocumentCommand {\umtWithoutArgsLong} {g g g g} {
    \IfNoValueTF{#1}
            { \um }
            {\IfNoValueTF{#2}
                {\um{#1} }
                { \IfNoValueTF{#3} 
                    { \mean{ U_{#1} U_{#2} } }
                    { \IfNoValueTF{#4}
                        { \mean{U_{#1} U_{#2} U_{#3}} }
                        { \mean{U_{#1} U_{#2} U_{#3} U_{#4}} }
                }
            }
        }
     }
\NewDocumentCommand {\umtWithArgsLong} {g g g g o o o o} {
        \IfNoValueTF{#1}
            { \um(\vv{#5}) }
            {\IfNoValueTF{#2}
                {\um{#1}(\vv{#5}) }
                { \IfNoValueTF{#3} 
                    { \mean{ U_{#1}(\vv{#5}) U_{#2}(\vv{#6})} }
                    { \IfNoValueTF{#4}
                        { \mean{ U_{#1}(\vv{#5}) U_{#2}(\vv{#6}) U_{#3}(\vv{#7})} }
                        { \mean{ U_{#1}(\vv{#5}) U_{#2}(\vv{#6}) U_{#3}(\vv{#7}) U_{#4}(\vv{#8})} }
                }
            }
        }
 }
\NewDocumentCommand {\umtLong} {g g g g o o o o} { 
    \IfNoValueTF{#5}
    { \umtWithoutArgsLong{#1}{#2}{#3}{#4} }
    { \IfBooleanTF{\ShowArgsTwoPoint}
        { \umtWithArgsLong{#1}{#2}{#3}{#4}[#5][#6][#7][#8] }
        { \umtWithoutArgsLong{#1}{#2}{#3}{#4} }
    }
}
 \NewDocumentCommand {\umt} {g g g g o o o o} { 
     \IfBooleanTF{\ShortHigherMoments}
     {\umtShort{#1}{#2}{#3}{#4}[#5][#6][#7][#8]}
     {\umtLong{#1}{#2}{#3}{#4}[#5][#6][#7][#8]}
 }
% fluctuation approach
\NewDocumentCommand {\uftWithoutArgsShort} {g g g g} {
    \IfNoValueTF{#1}
            { \uf }
            {\IfNoValueTF{#2}
                {\uf{#1} }
                { \IfNoValueTF{#3} 
                    {R_{#1 #2} }
                    { \IfNoValueTF{#4}
                        {R_{#1 #2 #3} }
                    {R_{#1 #2 #3 #4} }
                }
            }
        }
     }
\NewDocumentCommand {\uftWithArgsShort} {g g g g o o o o} {
        \IfNoValueTF{#1}
            { \uf(\vv{#5}) }
            {\IfNoValueTF{#2}
                {\uf{#1}(\vv{#5}) }
                { \IfNoValueTF{#3} 
                    {R_{#1 #2}(\vv{#5},\vv{#6}) }
                    { \IfNoValueTF{#4}
                        {R_{#1 #2 #3}(\vv{#5}, \vv{#6}, \vv{#7}) }
                        {R_{#1 #2 #3 #4}(\vv{#5}, \vv{#6}, \vv{#7}, \vv{#8}) }
                }
            }
        }
 }
\NewDocumentCommand {\uftShort} {g g g g o o o o} { 
    \IfNoValueTF{#5}
    { \uftWithoutArgsShort{#1}{#2}{#3}{#4} }
    { \IfBooleanTF{\ShowArgsTwoPoint}
        { \uftWithArgsShort{#1}{#2}{#3}{#4}[#5][#6][#7][#8] }
        { \uftWithoutArgsShort{#1}{#2}{#3}{#4} }
    }
}
\NewDocumentCommand {\uftWithoutArgsLong} {g g g g} {
    \IfNoValueTF{#1}
            { \uf }
            {\IfNoValueTF{#2}
                {\uf{#1} }
                { \IfNoValueTF{#3} 
                    { \mean{ u_{#1} u_{#2} } }
                    { \IfNoValueTF{#4}
                        { \mean{U_{#1} u_{#2} u_{#3}} }
                        { \mean{U_{#1} u_{#2} u_{#3} u_{#4}} }
                }
            }
        }
     }
\NewDocumentCommand {\uftWithArgsLong} {g g g g o o o o} {
        \IfNoValueTF{#1}
            { \uf(\vv{#5}) }
            {\IfNoValueTF{#2}
                {\uf{#1}(\vv{#5}) }
                { \IfNoValueTF{#3} 
                    { \mean{ u_{#1}(\vv{#5}) u_{#2}(\vv{#6})} }
                    { \IfNoValueTF{#4}
                        { \mean{ u_{#1}(\vv{#5}) u_{#2}(\vv{#6}) u_{#3}(\vv{#7})} }
                        { \mean{ u_{#1}(\vv{#5}) u_{#2}(\vv{#6}) u_{#3}(\vv{#7}) u_{#4}(\vv{#8})} }
                }
            }
        }
 }
\NewDocumentCommand {\uftLong} {g g g g o o o o} { 
    \IfNoValueTF{#5}
    { \uftWithoutArgsLong{#1}{#2}{#3}{#4} }
    { \IfBooleanTF{\ShowArgsTwoPoint}
        { \uftWithArgsLong{#1}{#2}{#3}{#4}[#5][#6][#7][#8] }
        { \uftWithoutArgsLong{#1}{#2}{#3}{#4} }
    }
}
 \NewDocumentCommand {\uft} {g g g g o o o o} { 
     \IfBooleanTF{\ShortHigherMoments}
     {\uftShort{#1}{#2}{#3}{#4}[#5][#6][#7][#8]}
     {\uftLong{#1}{#2}{#3}{#4}[#5][#6][#7][#8]}
 }
\NewDocumentCommand {\puf} { m o o } {
    \IfNoValueTF{#2}
        {\mean{pu_{#1}}}
        {\mean{pu_{#1}(\vv{#2},\vv{#3})}}
}
\NewDocumentCommand {\upf} { m o o } {
    \IfNoValueTF{#2}
        {\mean{u_{#1}p}}
        {\mean{u_{#1}p(\vv{#2},\vv{#3})}}
}
\NewDocumentCommand {\pum} { m o o } {
    \IfNoValueTF{#2}
        {\mean{PU_{#1}}}
        {\mean{PU_{#1}(\vv{#2},\vv{#3})}}
}
\NewDocumentCommand {\upm} { m o o } {
    \IfNoValueTF{#2}
        {\mean{U_{#1}P}}
        {\mean{U_{#1}P(\vv{#2},\vv{#3})}}
}
% turbulent viscosity
% \NewDocumentCommand {\nut} {} {\nu_{\text{turb}}}
\NewDocumentCommand {\nut} {} {\nu_{t}}
% artificial velocity 
\NewDocumentCommand {\ua} { g } { 
    \IfNoValueTF{#1}
        {\theta} 
        {\theta_{#1}} 
} 
% k- eps - model
\NewDocumentCommand {\kepsmodel} {} {\(k\)-\(\varepsilon\)-model}
